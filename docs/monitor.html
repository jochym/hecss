---

title: Monitor


keywords: fastai
sidebar: home_sidebar

summary: "Monitoring functions for HECSS sampler"
description: "Monitoring functions for HECSS sampler"
nb_path: "01_monitor.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 01_monitor.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">un</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">loadtxt</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">linspace</span><span class="p">,</span> <span class="n">histogram</span><span class="p">,</span> <span class="n">median</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">plot</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">subplot</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">semilogx</span><span class="p">,</span> <span class="n">semilogy</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">xticks</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">axhline</span><span class="p">,</span> <span class="n">axvline</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">un</span>
<span class="n">THz</span> <span class="o">=</span> <span class="mf">1e12</span> <span class="o">*</span> <span class="n">un</span><span class="o">.</span><span class="n">_hplanck</span> <span class="o">*</span> <span class="n">un</span><span class="o">.</span><span class="n">J</span> <span class="c1"># THz in eV</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_band_set</span><span class="p">(</span><span class="n">bnd</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">THz</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lbl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="n">kwa</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,)}</span>
    <span class="n">plt</span><span class="o">=</span><span class="n">plot</span><span class="p">(</span><span class="n">bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">un</span><span class="o">.</span><span class="n">invcm</span> <span class="o">*</span> <span class="n">bnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">units</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bnd</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
        <span class="n">plot</span><span class="p">(</span><span class="n">bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">un</span><span class="o">.</span><span class="n">invcm</span> <span class="o">*</span> <span class="n">b</span> <span class="o">/</span> <span class="n">units</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwa</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_bands</span><span class="p">(</span><span class="n">bnd</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">THz</span><span class="p">,</span> <span class="n">decorate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">plot_band_set</span><span class="p">(</span><span class="n">bnd</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">lbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">lbls</span><span class="p">,</span> <span class="n">pnts</span> <span class="o">=</span> <span class="n">kpnts</span>

    <span class="k">if</span> <span class="n">decorate</span><span class="p">:</span>
        <span class="n">xticks</span><span class="p">(</span><span class="n">pnts</span><span class="p">,</span> <span class="n">lbls</span><span class="p">)</span>
        <span class="n">xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pnts</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">pnts</span><span class="p">))</span>
        <span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pnts</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">axvline</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wave vector&#39;</span><span class="p">)</span>
        <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency (THz)&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_bands_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">THz</span><span class="p">,</span> <span class="n">decorate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">bnd</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">p_lbl</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">if</span> <span class="n">l</span><span class="o">!=</span><span class="s1">&#39;G&#39;</span> <span class="k">else</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Gamma$&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">p_pnt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">kpnts</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_lbl</span><span class="p">,</span> <span class="n">p_pnt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lbl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lbl</span><span class="o">=</span><span class="n">fn</span>

    <span class="n">plot_bands</span><span class="p">(</span><span class="n">bnd</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">decorate</span><span class="p">,</span> <span class="n">lbl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_alamode</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="s1">&#39;phon&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;cryst&#39;</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="s1">&#39;cryst&#39;</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="s1">&#39;DFSET&#39;</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="s1">&#39;../sc/CONTCAR&#39;</span><span class="p">,</span>
                <span class="n">o</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fit_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/home/jochym/Projects/alamode-tools/devel/make-gen.py opt -p </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> -n </span><span class="si">{</span><span class="n">sc</span><span class="si">}</span><span class="s1"> -f </span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1"> -o </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1"> --c2 </span><span class="si">{</span><span class="n">c2</span><span class="si">}</span><span class="s1"> -d </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">charge</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">charge</span> <span class="o">=</span> <span class="n">prefix</span>
    <span class="k">if</span> <span class="n">born</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;-b </span><span class="si">{</span><span class="n">born</span><span class="si">}</span><span class="s1"> -c </span><span class="si">{</span><span class="n">charge</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">phon_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/home/jochym/Projects/alamode-tools/devel/make-gen.py phon -p </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1"> -n </span><span class="si">{</span><span class="n">sc</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s1"> -k </span><span class="si">{</span><span class="n">kpath</span><span class="si">}</span><span class="s1">.path&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">alm_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/home/jochym/public/bin/alm </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_fit.in&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">anph_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/home/jochym/public/bin/anphon </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_phon.in&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_fit.in&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fit_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">ff</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_phon.in&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">phon</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">phon_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">ff</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="n">alm</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">alm_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">anph</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">anph_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">fit</span><span class="p">,</span> <span class="n">phon</span><span class="p">,</span> <span class="n">alm</span><span class="p">,</span> <span class="n">anph</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="s1">&#39;phon&#39;</span><span class="p">,</span> <span class="s1">&#39;alm&#39;</span><span class="p">,</span> <span class="s1">&#39;anphon&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lf</span><span class="p">:</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">.err&#39;</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">lf</span><span class="p">:</span>
                <span class="n">lf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">returncode</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span>  <span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">phon</span><span class="p">,</span> <span class="n">alm</span><span class="p">,</span> <span class="n">anph</span><span class="p">)]),</span> <span class="n">fit</span><span class="p">,</span> <span class="n">phon</span><span class="p">,</span> <span class="n">alm</span><span class="p">,</span> <span class="n">anph</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_dfset_len</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="s1">&#39;phon/DFSET&#39;</span><span class="p">):</span>
    <span class="k">try</span> <span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">dfset</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dfset</span> <span class="k">if</span> <span class="s1">&#39;set:&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">show_dc_conv</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">max_plots</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">prev_n</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bl</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plot_bands</span><span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="n">prev_n</span><span class="p">],</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prev_n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>
    <span class="n">y_lims</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">()</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">plotted</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bl</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">prev_n</span><span class="o">*</span><span class="mf">0.75</span> <span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">alpha</span> <span class="o">*=</span> <span class="mf">0.8</span>
        <span class="n">plot_band_set</span><span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">lbl</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plotted</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prev_n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">plotted</span> <span class="o">&gt;</span> <span class="n">max_plots</span> <span class="p">:</span>
            <span class="k">break</span>
    <span class="n">ylim</span><span class="p">(</span><span class="n">y_lims</span><span class="p">)</span>
    <span class="n">legend</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_bnd_lst</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;phon&#39;</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="s1">&#39;DFSET&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;cryst&#39;</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="s1">&#39;crast&#39;</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="s1">&#39;../sc/CONTCAR&#39;</span><span class="p">,</span>
                  <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">bl</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using first </span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s1">3</span><span class="si">}</span><span class="s1"> samples&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">run_alamode</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="n">dfset</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="n">kpath</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span>
                    <span class="n">o</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="n">born</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
        <span class="n">bl</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.bands&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">bl</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">build_omega</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">):</span>
    <span class="n">omega</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">eps</span><span class="o">=</span><span class="mf">1e-3</span>
    <span class="n">kp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">kpnts</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">([[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">bnd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="nb">abs</span><span class="p">(</span><span class="n">bnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">v</span><span class="p">)</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">bnd</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bl</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span><span class="o">-</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">omega</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">omega</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_omega</span><span class="p">(</span><span class="n">omega</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">omega</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">2</span> <span class="p">:</span>
            <span class="k">return</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Gamma$&#39;</span>
        <span class="n">semilogy</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">un</span><span class="o">.</span><span class="n">invcm</span> <span class="o">*</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">THz</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>

    <span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">un</span><span class="o">.</span><span class="n">invcm</span><span class="o">*</span><span class="n">median</span><span class="p">([</span><span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">omega</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="o">/</span><span class="n">THz</span>
    <span class="k">if</span> <span class="n">rng</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
        <span class="n">ylim</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="c1">#axhline(0, ls=&#39;:&#39;, lw=1)</span>
    <span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency convergence (THz)&#39;</span><span class="p">)</span>
    <span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of samples&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">monitor_phonons</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="s1">&#39;phon&#39;</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="s1">&#39;DFSET&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;cryst&#39;</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="s1">&#39;cryst&#39;</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="s1">&#39;../sc/CONTCAR&#39;</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">update_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">bnd_lst</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">k_lst</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="p">(</span><span class="n">dcplt</span><span class="p">,</span> <span class="n">omplt</span><span class="p">)</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sca</span><span class="p">(</span><span class="n">dcplt</span><span class="p">)</span>
        <span class="n">show_dc_conv</span><span class="p">(</span><span class="n">bnd_lst</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">)</span>
        <span class="n">sca</span><span class="p">(</span><span class="n">omplt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k_lst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_omega</span><span class="p">(</span><span class="n">build_omega</span><span class="p">(</span><span class="n">bnd_lst</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">))</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">plot_omega</span><span class="p">(</span><span class="n">build_omega</span><span class="p">(</span><span class="n">bnd_lst</span><span class="p">,</span>
                                        <span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">kpnts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">k_lst</span><span class="p">],</span>
                                         <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">kpnts</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">k_lst</span><span class="p">])))</span>
        <span class="n">show</span><span class="p">()</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="n">bnd_lst</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for the first sample.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
           <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
           <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
           <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the plots.&#39;</span><span class="p">,)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">run_alamode</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="n">dfset</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="n">kpath</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span>
                <span class="n">o</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="n">born</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
    <span class="n">bnd_lst</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.bands&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">prev_N</span> <span class="o">=</span> <span class="n">N</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.bands&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">p_lbl</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">if</span> <span class="n">v</span><span class="o">!=</span><span class="s1">&#39;G&#39;</span> <span class="k">else</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Gamma$&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">p_pnt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">kpnts</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_lbl</span><span class="p">,</span> <span class="n">p_pnt</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">update_fig</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">bnd_lst</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">k_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fig_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">fig_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span> <span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">prev_N</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">run_alamode</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="n">dfset</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="n">kpath</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span>
                            <span class="n">o</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="n">born</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">bnd_lst</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.bands&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">update_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">bnd_lst</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">k_list</span><span class="p">)</span>
                <span class="n">prev_N</span> <span class="o">=</span> <span class="n">N</span>
                <span class="k">if</span> <span class="n">fig_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">fig_out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">fig</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">SN</span> <span class="o">=</span> <span class="n">N</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">all_done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">SN</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">NN</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">SN</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">NN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bnd_lst</span><span class="p">:</span>
                        <span class="n">all_done</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">run_alamode</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="n">dfset</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">kpath</span><span class="o">=</span><span class="n">kpath</span><span class="p">,</span> <span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span>
                                        <span class="n">o</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">,</span> <span class="n">c2</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">born</span><span class="o">=</span><span class="n">born</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">bnd_lst</span><span class="p">[</span><span class="n">NN</span><span class="p">]</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.bands&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                            <span class="n">fig</span> <span class="o">=</span> <span class="n">update_fig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">bnd_lst</span><span class="p">,</span> <span class="n">kpnts</span><span class="p">,</span> <span class="n">k_list</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">fig_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
                                <span class="n">fig_out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">fig</span>
                    <span class="k">if</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">prev_N</span><span class="p">:</span>
                        <span class="n">SN</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">all_done</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="n">SN</span> <span class="o">=</span> <span class="n">SN</span><span class="o">//</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">all_done</span><span class="p">:</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">plot_stats</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="s1">&#39;phon&#39;</span><span class="p">,</span> <span class="n">dfsetfn</span><span class="o">=</span><span class="s1">&#39;DFSET&#39;</span><span class="p">,</span> <span class="n">sqrN</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plotchi2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot monitoring histograms for the configuration list in confs.</span>
<span class="sd">    If len(confs)&lt;3 this function is silent.</span>

<span class="sd">    confs - configuration list</span>
<span class="sd">    nat   - number of atoms in the structure</span>
<span class="sd">    T     - target temperature in Kelvin</span>
<span class="sd">    show  - call show() fuction at the end (default:True)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfsetfn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">dfset</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfsetfn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">nat</span><span class="o">=</span><span class="n">dfset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">confs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">es</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfsetfn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dff</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;set:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">es</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="c1">#E0 = Vasp2(restart=base_dir+&#39;/../calc/&#39;).get_potential_energy()</span>
    <span class="c1">#es = [(Vasp2(restart=d).get_potential_energy()-E0)/nat</span>
    <span class="c1">#          for d in sorted(glob(base_dir+&#39;/../calc/T_600.0K/smpl/0*/&#39;))]</span>

    <span class="n">es</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>
    <span class="n">E_goal</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">un</span><span class="o">.</span><span class="n">kB</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">Es</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">un</span><span class="o">.</span><span class="n">kB</span><span class="o">*</span><span class="n">T</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nat</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">E_goal</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">Es</span><span class="p">,</span> <span class="n">E_goal</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">Es</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> samples&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">histogram</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">de</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">sqrN</span> <span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">de</span><span class="p">,</span>
                        <span class="n">yerr</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">de</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$1/</span><span class="se">\\</span><span class="s1">sqrt</span><span class="si">{N}</span><span class="s1">$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">E_goal</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target energy&#39;</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">E_goal</span><span class="p">,</span> <span class="n">Es</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>  <span class="p">(</span><span class="n">pdf</span><span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdf</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">pdf</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdf</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$(1,2,3)/</span><span class="se">\\</span><span class="s1">sqrt</span><span class="si">{N}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>  <span class="p">(</span><span class="n">pdf</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdf</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">pdf</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdf</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>  <span class="p">(</span><span class="n">pdf</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdf</span><span class="p">))</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">pdf</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pdf</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Target normal dist.&#39;</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">es</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>  <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">fit</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted normal dist.&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plotchi2</span> <span class="p">:</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">nat</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>  <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">fit</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted $</span><span class="se">\\</span><span class="s1">chi^2$ dist.&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Potential energy (eV/at)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Probability density&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">E_goal</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">Es</span><span class="p">,</span><span class="n">E_goal</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">Es</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">show</span> <span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">monitor_stats</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;phon&#39;</span><span class="p">,</span> <span class="n">dfset</span><span class="o">=</span><span class="s1">&#39;DFSET&#39;</span><span class="p">,</span> <span class="n">plotchi2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">prev_N</span> <span class="o">=</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for the first samples (&gt;2).&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
           <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
           <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
           <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done.&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating the plots.&#39;</span><span class="p">,)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span> <span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">get_dfset_len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">dfset</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">prev_N</span> <span class="p">:</span>
            <span class="n">plot_stats</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">dfsetfn</span><span class="o">=</span><span class="n">dfset</span><span class="p">,</span> <span class="n">plotchi2</span><span class="o">=</span><span class="n">plotchi2</span><span class="p">)</span>
            <span class="n">show</span><span class="p">()</span>
            <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">prev_N</span> <span class="o">=</span> <span class="n">N</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

