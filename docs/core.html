---

title: Core


keywords: fastai
sidebar: home_sidebar

summary: "The core functionality of the HECSS module is provided by the `HECSS` factory function,"
description: "The core functionality of the HECSS module is provided by the `HECSS` factory function,"
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="normalize_conf" class="doc_header"><code>normalize_conf</code><a href="https://gitlab.com/jochym/hecss/tree/nbdev/hecss/core.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>normalize_conf</code>(<strong><code>c</code></strong>, <strong><code>base</code></strong>)</p>
</blockquote>
<p>Normalize the configuration <code>c</code> relative to the basic structure <code>base</code>.
Normalization is performed by "nuwrapping" the displacements of atoms
when they cross the periodic boundary conditions in such a way that the
atoms are not "jumping" from one side of the cell to the other.</p>
<p>E.g. if the atom at r=(0,0,0) goes to the relative position (-0.01, 0, 0)
it is "wrapped" by PBC to the r=(0.99, 0, 0). Thus if we naiively calculate
the displacement we will get a large positive displacement (0.99 of the cell
vector) instead of a small negative one.</p>
<p>This function reverses that process making the positions suitable for
differentiation. The positions may be part of a continous trajectory or
just independent configurations. This makes it impossible for described
procedure to work if the displacements are above 1/2 of the unit cell.
For sefety this implementation is limited to displacements &lt; 1/3 of the
unit cell. If any coordinate changes by more then 1/3 the function
will rise an AssertionError exception.</p>
<p>This implementation is not suitable for tracking positions in the system
with systematic drift (e.g. long MD trajectory with non-perfect momentum
conservation). For stronger implementation suitable for such cases look
at dxutils package.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ase.build</span> <span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">allclose</span>

<span class="c1"># Use structure with most of the atoms </span>
<span class="c1"># on the surface of the unit cell: rocksalt</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="s1">&#39;NaCl&#39;</span><span class="p">,</span> <span class="s1">&#39;rocksalt&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="s1">&#39;NaCl&#39;</span><span class="p">,</span> <span class="s1">&#39;rocksalt&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Displace the atoms</span>
<span class="n">c</span><span class="o">.</span><span class="n">rattle</span><span class="p">(</span><span class="n">stdev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Store unwrapped positions</span>
<span class="n">unwrapped</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(</span><span class="n">wrap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Wrap the positions</span>
<span class="n">c</span><span class="o">.</span><span class="n">set_scaled_positions</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(</span><span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1"># Check if the reversal worked</span>
<span class="k">assert</span> <span class="n">allclose</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">,</span> <span class="n">normalize_conf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_dfset" class="doc_header"><code>write_dfset</code><a href="https://gitlab.com/jochym/hecss/tree/nbdev/hecss/core.py#L61" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_dfset</code>(<strong><code>fn</code></strong>, <strong><code>c</code></strong>)</p>
</blockquote>
<p>Append displacement-force data from the conf to the fn file.
The format is suitable for use as ALAMODE DFSET file.
Optionaly you can provide configuration number in n.
File need not exist prior to first call.
If it does not it will be created.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="HECSS" class="doc_header"><code>HECSS</code><a href="https://gitlab.com/jochym/hecss/tree/nbdev/hecss/core.py#L80" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>HECSS</code>(<strong><code>cryst</code></strong>, <strong><code>calc</code></strong>, <strong><code>T_goal</code></strong>, <strong><code>width</code></strong>=<em><code>1</code></em>, <strong><code>maxburn</code></strong>=<em><code>20</code></em>, <strong><code>N</code></strong>=<em><code>None</code></em>, <strong><code>w_search</code></strong>=<em><code>True</code></em>, <strong><code>delta_sample</code></strong>=<em><code>0.01</code></em>, <strong><code>directory</code></strong>=<em><code>None</code></em>, <strong><code>reuse_base</code></strong>=<em><code>None</code></em>, <strong><code>verb</code></strong>=<em><code>True</code></em>, <strong><code>priors</code></strong>=<em><code>None</code></em>, <strong><code>posts</code></strong>=<em><code>None</code></em>, <strong><code>width_list</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Run HECS sampler on the system <code>cryst</code> using calculator <code>calc</code> at target
temperature <code>T_goal</code>. The <code>delta</code>, <code>width</code>, <code>maxburn</code> and <code>directory</code> parameters
determine detailed aspects of the algorithm.</p>
<p>This is a generator and cannot be used as regular function.
It is intended to be used as a source of the sequence of
configurations in the <code>for</code> loop and must be closed after
finishing the iteration. On the other hand, the iteration
may be continued if additional samples are required.
The state is preserved until the .close() method is called.</p>
<h3 id="Example">Example<a class="anchor-link" href="#Example"> </a></h3><p>Assuming <code>N</code> is a number of requested samples.</p>

<pre><code>sampler = HECSS(cryst, calc, T)
for i, x, f, e in sampler:
    process_sample(i, x, f, e)
    if i &gt; N :
        break
sampler.close()</code></pre>
<h3 id="INPUT">INPUT<a class="anchor-link" href="#INPUT"> </a></h3><p>cryst        - ASE structure to sample
calc         - ASE calculator to use for potential energy evaluations
T_goal       - Target temperature in Kelvin
width        - initial width of the position distribution,
               relative to the heurestic value defined inside function
maxburn      - max number of burn-in steps
N            - Number of iterations. If None (default) the generator will never terminate.
w_search     - Run search for initial w. If false start from whatever is passed as width.
delta_sample - Prior width adaptation rate. The default is sufficient in most cases.</p>
<p>directory    - (only for VASP calculator) directory for calculations and generated samples .
               If left as None, the <code>calc/{T_goal:.1f}K/</code> will be used and the generated
               samples will be stored in the <code>smpl/{i:04d}</code> subdirectories.</p>
<p>reuse_base   - (only for VASP calculator) None or the base calc directory for the ground
               state config. If None the base will be recalculated at the start of the run.
               If directory name - the energy from this dir will be reused as ground state
               energy for the calculation. Be careful to have the same VASP setup in calc
               and reuse_base, otherwise the ground state energy and distribution will be wrong.</p>
<p>verb         - print verbose progress messages for interactive use</p>
<h4 id="Output-parameters">Output parameters<a class="anchor-link" href="#Output-parameters"> </a></h4><p>priors       - Output parameter. If not None, store in passed list the sequence of priors.
posts        - Output parameter. If not None, store in passed list the sequence of posteriors.
width_list   - Output parameter. If not None, store in passed list the sequence of widths.</p>
<h3 id="OUTPUT">OUTPUT<a class="anchor-link" href="#OUTPUT"> </a></h3><p>The generator yields samples from the thermodynamic distribution at T=T_goal as tuples
(number, index, displacement, forces, energy):
number       - sample number, always increasing
index        - integer numbering the samples in the <code>smpl</code> subdirectory. The index may
               repeat if the sample must be repeated in the sequence.
displacement - set of atomic displacements (in A) in the sample (numpy array)
forces       - set of forces (in eV/A) generated by the displacement
energy       - potential energy of the configuration</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">old_HECSS</span><span class="p">(</span><span class="n">cryst</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">T_goal</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.033</span><span class="p">,</span> <span class="n">maxburn</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reuse_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Run HECS sampler on the system `cryst` using calculator `calc` at target</span>
<span class="sd">    temperature `T_goal`. The `delta`, `width`, `maxburn` and `directory` parameters</span>
<span class="sd">    determine detailed aspects of the algorithm.</span>

<span class="sd">    This is a generator and cannot be used as regular function. </span>
<span class="sd">    It is intended to be used as a source of the sequence of </span>
<span class="sd">    configurations in the `for` loop and must be closed after </span>
<span class="sd">    finishing the iteration. On the other hand, the iteration </span>
<span class="sd">    may be continued if additional samples are required. </span>
<span class="sd">    The state is preserved until the .close() method is called.</span>

<span class="sd">    ```</span>
<span class="sd">    sampler = HECSS(cryst, calc, T)</span>
<span class="sd">    for i, x, f, e in sampler:</span>
<span class="sd">        process_sample(i, x, f, e)</span>
<span class="sd">        if i &gt; N :</span>
<span class="sd">            break</span>
<span class="sd">    sampler.close()</span>
<span class="sd">    ```</span>

<span class="sd">    INPUT</span>
<span class="sd">    </span>
<span class="sd">    cryst   - ASE structure to sample</span>
<span class="sd">    calc    - ASE calculator to use for potential energy evaluations</span>
<span class="sd">    T_goal  - Target temperature in Kelvin</span>

<span class="sd">    delta   - speed of the adaptation - maximal change of the prior width in one step</span>
<span class="sd">    width   - initial width of the position distribution in Angstrom</span>
<span class="sd">    maxburn - max number of burn-in steps</span>
<span class="sd">    sigma   - width in energy sigmas of the prior energy distribution.</span>
<span class="sd">              This should be approx 2 (default), if your posteriors seem too narrow</span>
<span class="sd">              make it bigger, if too wide make it smaller (1-3 range in general).</span>
<span class="sd">              Too large a number makes the acceptance ratio lower.</span>

<span class="sd">    directory - directory for calculations and generated samples. If left as None,</span>
<span class="sd">                the `calc/{T_goal:.1f}K/` will be used and the generated samples will be </span>
<span class="sd">                stored in the `smpl/{i:04d}` subdirectories.</span>

<span class="sd">    reuse_base - None or the base calc directory for the ground state config</span>
<span class="sd">                 if None the base will be recalculated at the start of the run</span>
<span class="sd">                 if directory name - the energy from this dir will be reused as </span>
<span class="sd">                 ground state energy for the calculation.</span>
<span class="sd">                 Be careful to have the same VASP setup in calc and reuse_base,</span>
<span class="sd">                 otherwise the ground state energy and distribution wil be wrong.</span>

<span class="sd">    verb    - print verbose progress messages for interactive use</span>

<span class="sd">    OUTPUT</span>
<span class="sd">    </span>
<span class="sd">    The generator yields samples from the thermodynamic distribution at T=T_goal as tuples</span>
<span class="sd">    (index, displacement, forces, energy):</span>
<span class="sd">    index        - integer numbering the samples in the `smpl` subdirectory. The index may</span>
<span class="sd">                   repeat if the sample must be repeated in the sequence. </span>
<span class="sd">    displacement - set of atomic displacements (in A) in the sample (numpy array)</span>
<span class="sd">    forces       - set of forces (in eV/A) generated by the displacement</span>
<span class="sd">    energy       - potential energy of the configuration</span>

<span class="sd">    &#39;&#39;&#39;</span>    

    <span class="k">def</span> <span class="nf">smpl_print</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Burn-in sample:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">  w:</span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">  alpha:</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">6.4e</span><span class="si">}</span><span class="s1">  dE:</span><span class="si">{</span><span class="p">(</span><span class="n">e_star</span><span class="o">-</span><span class="n">E_goal</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Es</span><span class="p">)</span><span class="si">:</span><span class="s1">+6.2f</span><span class="si">}</span><span class="s1"> sigma&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sample:</span><span class="si">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">  a:</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="n">n</span><span class="si">:</span><span class="s1">5.1f</span><span class="si">}</span><span class="s1">%  w:</span><span class="si">{</span><span class="n">w</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">  &lt;w&gt;:</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">  alpha:</span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">6g</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


    <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating base structure.    &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">nat</span> <span class="o">=</span> <span class="n">cryst</span><span class="o">.</span><span class="n">get_global_number_of_atoms</span><span class="p">()</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reuse_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">calc0</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">calculators</span><span class="o">.</span><span class="n">vasp</span><span class="o">.</span><span class="n">Vasp2</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">reuse_base</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Ep0</span> <span class="o">=</span> <span class="n">calc0</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">Ep0</span> <span class="o">=</span> <span class="n">cryst</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span>
    
    <span class="n">E_goal</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">T_goal</span><span class="o">*</span><span class="n">un</span><span class="o">.</span><span class="n">kB</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">Es</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">un</span><span class="o">.</span><span class="n">kB</span><span class="o">*</span><span class="n">T_goal</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nat</span><span class="p">)</span>   
    
    <span class="n">P</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span>
    
    <span class="n">w</span> <span class="o">=</span> <span class="n">width</span>
    <span class="n">w_prev</span> <span class="o">=</span> <span class="n">w</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">wl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;calc/T_</span><span class="si">{</span><span class="n">T_goal</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">K&#39;</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">basedir</span> <span class="o">=</span> <span class="n">directory</span>

    <span class="n">cr</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">(</span><span class="n">numbers</span> <span class="o">=</span> <span class="n">cryst</span><span class="o">.</span><span class="n">get_atomic_numbers</span><span class="p">(),</span> 
                   <span class="n">cell</span><span class="o">=</span><span class="n">cryst</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(),</span>
                   <span class="n">scaled_positions</span><span class="o">=</span><span class="n">cryst</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(),</span>
                   <span class="n">pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calculator</span><span class="o">=</span><span class="n">calc</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating initial sample.    &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">cr</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">cryst</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s1">/smpl/</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span><span class="o">-</span><span class="n">Ep0</span><span class="p">)</span><span class="o">/</span><span class="n">nat</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_forces</span><span class="p">()</span>
    
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span>

    
    <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting burn-in.            &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">smpl_print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="n">x_star</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

        <span class="n">cr</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">cryst</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span><span class="o">+</span><span class="n">x_star</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">basedir</span><span class="si">}</span><span class="s1">/smpl/</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">e_star</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">get_potential_energy</span><span class="p">()</span><span class="o">-</span><span class="n">Ep0</span><span class="p">)</span><span class="o">/</span><span class="n">nat</span>
        <span class="n">f_star</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_forces</span><span class="p">()</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">P</span><span class="p">(</span><span class="n">e_star</span><span class="p">,</span> <span class="n">E_goal</span><span class="p">,</span> <span class="n">Es</span><span class="p">)</span> <span class="o">/</span> <span class="n">P</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">E_goal</span><span class="p">,</span> <span class="n">Es</span><span class="p">)</span>
        
        <span class="n">q_x</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w_prev</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">q_star_x_star</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_star</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">q_star_x</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">q_x_star</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">Q</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_star</span><span class="p">,</span> <span class="n">w_prev</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">alpha</span> <span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="n">q_x</span> <span class="o">+</span> <span class="n">q_star_x_star</span> <span class="o">-</span> <span class="n">q_star_x</span> <span class="o">-</span> <span class="n">q_x_star</span><span class="p">)</span>

        <span class="n">w_prev</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">w</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">expit</span><span class="p">((</span><span class="n">e_star</span><span class="o">-</span><span class="n">E_goal</span><span class="p">)</span><span class="o">/</span><span class="n">Es</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_star</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">e_star</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f_star</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e_star</span><span class="o">-</span><span class="n">E_goal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">Es</span> <span class="p">:</span>
                <span class="c1"># At the burn-in stage and still further then 2 sigma from target</span>
                <span class="c1"># Let us keep searching for correct w</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="n">maxburn</span> <span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error: reached maxburn (</span><span class="si">{</span><span class="n">maxburn</span><span class="si">}</span><span class="s1">) without finding target energy.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span>
                      <span class="sa">f</span><span class="s1">&#39;You probably need to change initial width parameter to a </span><span class="si">{</span><span class="s2">&quot;higher&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">e_star</span><span class="o">-</span><span class="n">E_goal</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;lower&quot;</span><span class="si">}</span><span class="s1"> value.&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">continue</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="c1"># We are at sampling stage or just found the proper w</span>
                <span class="c1"># Either way: switch to the next sample directory (i)</span>
                <span class="c1"># and zero the rejection counter</span>
                <span class="n">wl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Sample rejected - nothing to yield. Try again</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
            <span class="n">smpl_print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

