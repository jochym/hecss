---

title: Core


keywords: fastai
sidebar: home_sidebar

summary: "The core functionality of the HECSS module is provided by the `HECSS` factory function,"
description: "The core functionality of the HECSS module is provided by the `HECSS` factory function,"
nb_path: "00_core.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 00_core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="normalize_conf" class="doc_header"><code>normalize_conf</code><a href="https://gitlab.com/jochym/hecss/tree/nbdev/hecss/core.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>normalize_conf</code>(<strong><code>c</code></strong>, <strong><code>base</code></strong>)</p>
</blockquote>
<p>Normalize the configuration <code>c</code> relative to the basic structure <code>base</code>.
Normalization is performed by "nuwrapping" the displacements of atoms
when they cross the periodic boundary conditions in such a way that the
atoms are not "jumping" from one side of the cell to the other.</p>
<p>E.g. if the atom at r=(0,0,0) goes to the relative position (-0.01, 0, 0)
it is "wrapped" by PBC to the r=(0.99, 0, 0). Thus if we naiively calculate
the displacement we will get a large positive displacement (0.99 of the cell
vector) instead of a small negative one.</p>
<p>This function reverses that process making the positions suitable for
differentiation. The positions may be part of a continous trajectory or
just independent configurations. This makes it impossible for described
procedure to work if the displacements are above 1/2 of the unit cell.
For sefety this implementation is limited to displacements &lt; 1/3 of the
unit cell. If any coordinate changes by more then 1/3 the function
will rise an AssertionError exception.</p>
<p>This implementation is not suitable for tracking positions in the system
with systematic drift (e.g. long MD trajectory with non-perfect momentum
conservation). For stronger implementation suitable for such cases look
at dxutils package.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">ase.build</span> <span class="kn">import</span> <span class="n">bulk</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">allclose</span>

<span class="c1"># Use structure with most of the atoms </span>
<span class="c1"># on the surface of the unit cell: rocksalt</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="s1">&#39;NaCl&#39;</span><span class="p">,</span> <span class="s1">&#39;rocksalt&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">bulk</span><span class="p">(</span><span class="s1">&#39;NaCl&#39;</span><span class="p">,</span> <span class="s1">&#39;rocksalt&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">3.6</span><span class="p">,</span> <span class="n">cubic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Displace the atoms</span>
<span class="n">c</span><span class="o">.</span><span class="n">rattle</span><span class="p">(</span><span class="n">stdev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Store unwrapped positions</span>
<span class="n">unwrapped</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(</span><span class="n">wrap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Wrap the positions</span>
<span class="n">c</span><span class="o">.</span><span class="n">set_scaled_positions</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get_scaled_positions</span><span class="p">(</span><span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1"># Check if the reversal worked</span>
<span class="k">assert</span> <span class="n">allclose</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">,</span> <span class="n">normalize_conf</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">b</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="write_dfset" class="doc_header"><code>write_dfset</code><a href="https://gitlab.com/jochym/hecss/tree/nbdev/hecss/core.py#L61" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>write_dfset</code>(<strong><code>fn</code></strong>, <strong><code>c</code></strong>)</p>
</blockquote>
<p>Append displacement-force data from the conf to the fn file.
The format is suitable for use as ALAMODE DFSET file.
Optionaly you can provide configuration number in n.
File need not exist prior to first call.
If it does not it will be created.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="HECSS" class="doc_header"><code>HECSS</code><a href="https://gitlab.com/jochym/hecss/tree/nbdev/hecss/core.py#L80" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>HECSS</code>(<strong><code>cryst</code></strong>, <strong><code>calc</code></strong>, <strong><code>T_goal</code></strong>, <strong><code>width</code></strong>=<em><code>1</code></em>, <strong><code>maxburn</code></strong>=<em><code>20</code></em>, <strong><code>N</code></strong>=<em><code>None</code></em>, <strong><code>w_search</code></strong>=<em><code>True</code></em>, <strong><code>delta_sample</code></strong>=<em><code>0.01</code></em>, <strong><code>directory</code></strong>=<em><code>None</code></em>, <strong><code>reuse_base</code></strong>=<em><code>None</code></em>, <strong><code>verb</code></strong>=<em><code>True</code></em>, <strong><code>priors</code></strong>=<em><code>None</code></em>, <strong><code>posts</code></strong>=<em><code>None</code></em>, <strong><code>width_list</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Run HECS sampler on the system <code>cryst</code> using calculator <code>calc</code> at target
temperature <code>T_goal</code>. The <code>delta</code>, <code>width</code>, <code>maxburn</code> and <code>directory</code> parameters
determine detailed aspects of the algorithm.</p>
<p>This is a generator and cannot be used as regular function.
It is intended to be used as a source of the sequence of
configurations in the <code>for</code> loop and must be closed after
finishing the iteration. On the other hand, the iteration
may be continued if additional samples are required.
The state is preserved until the .close() method is called.</p>
<h2 id="INPUT">INPUT<a class="anchor-link" href="#INPUT"> </a></h2><ul>
<li>cryst        : ASE structure to sample</li>
<li>calc         : ASE calculator to use for potential energy evaluations</li>
<li>T_goal       : Target temperature in Kelvin</li>
<li>width        : initial width of the position distribution,
<pre><code>        relative to the heurestic value defined inside function</code></pre>
</li>
<li>maxburn      : max number of burn-in steps</li>
<li>N            : Number of iterations. If None (default) the generator will never terminate.</li>
<li>w_search     : Run search for initial w. If false start from whatever is passed as width.</li>
<li>delta_sample : Prior width adaptation rate. The default is sufficient in most cases.</li>
<li>directory    : (only for VASP calculator) directory for calculations and generated samples .
<pre><code>         If left as None, the `calc/{T_goal:.1f}K/` will be used and the generated
         samples will be stored in the `smpl/{i:04d}` subdirectories.</code></pre>
</li>
<li>reuse_base   : (only for VASP calculator) None or the base calc directory for the ground
<pre><code>         state config. If None the base will be recalculated at the start of the run.
         If directory name - the energy from this dir will be reused as ground state
         energy for the calculation. Be careful to have the same VASP setup in calc
         and reuse_base, otherwise the ground state energy and distribution will be wrong.</code></pre>
</li>
<li>verb         : print verbose progress messages for interactive use</li>
</ul>
<p><strong>Output parameters</strong></p>
<ul>
<li>priors     : Output parameter. If not None, store in passed list the sequence of priors.</li>
<li>posts      : Output parameter. If not None, store in passed list the sequence of posteriors.</li>
<li>width_list : Output parameter. If not None, store in passed list the sequence of widths.</li>
</ul>
<h2 id="OUTPUT">OUTPUT<a class="anchor-link" href="#OUTPUT"> </a></h2><p>The generator yields samples from the thermodynamic distribution at T=T_goal as tuples
(number, index, displacement, forces, energy):</p>
<ul>
<li>number       : sample number, always increasing</li>
<li>index        : integer numbering the samples in the <code>smpl</code> subdirectory. The index may
<pre><code>         repeat if the sample must be repeated in the sequence.</code></pre>
</li>
<li>displacement : set of atomic displacements (in A) in the sample (numpy array)</li>
<li>forces       : set of forces (in eV/A) generated by the displacement</li>
<li>energy       : potential energy of the configuration</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Example">Example<a class="anchor-link" href="#Example"> </a></h2><p>A general usage scheme runs the sampler in the for loop as an iterator providing series of samples.</p>
<ul>
<li><code>N</code>: number of requested samples, </li>
<li><code>cryst</code> : structure to be calculated,</li>
<li><code>calc</code> : ASE calculator</li>
<li><code>T</code>: target temperature in Kelvin.</li>
</ul>
<p>Loop variables:</p>
<ul>
<li><code>i</code> : sample number</li>
<li><code>x</code> : displacement vector</li>
<li><code>f</code> : forces</li>
<li><code>e</code> : potential energy</li>
</ul>
<p>The main loop should be structured like this:</p>
<div class="highlight"><pre><span></span><span class="n">sampler</span> <span class="o">=</span> <span class="n">HECSS</span><span class="p">(</span><span class="n">cryst</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">sampler</span><span class="p">:</span>
    <span class="n">process_sample</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">N</span> <span class="p">:</span>
        <span class="k">break</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>
</div>
 

