---

title: VASP Tutorial


keywords: fastai
sidebar: home_sidebar



nb_path: "04_VASP_Tutorial.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 04_VASP_Tutorial.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Import VASP calculator and unit modules</span>
<span class="kn">from</span> <span class="nn">ase.calculators.vasp</span> <span class="kn">import</span> <span class="n">Vasp2</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">un</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isfile</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># The sample generator, monitoring display and dfset writer</span>
<span class="kn">from</span> <span class="nn">hecss.core</span> <span class="kn">import</span> <span class="n">HECSS</span><span class="p">,</span> <span class="n">write_dfset</span>

<span class="c1"># clear_output function for nice monitoring display</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">clear_output</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">supercell</span> <span class="o">=</span> <span class="s1">&#39;1x1x1&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">supercell</span> <span class="o">=</span> <span class="s1">&#39;2x2x2&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Directory in which our project resides</span>
<span class="n">base_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;example/VASP_3C-SiC/</span><span class="si">{</span><span class="n">supercell</span><span class="si">}</span><span class="s1">/&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Desired number of samples.</span>
<span class="c1"># Here 4 is minimal in 3C-SiC </span>
<span class="c1"># to get somewhat decent cubic phonons </span>
<span class="c1"># with 10 Bohr cutoff.</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Temperature (K)</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">300</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Read the structure (previously calculated unit(super) cell)</span>
<span class="c1"># The command argument is specific to the cluster setup</span>
<span class="n">calc</span> <span class="o">=</span> <span class="n">Vasp2</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;cryst&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/sc_</span><span class="si">{</span><span class="n">supercell</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># This just makes a copy of atoms object</span>
<span class="c1"># Do not generate supercell here - your atom ordering will be wrong!</span>
<span class="n">cryst</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you have magmoms in your system you need to use following 
temporary fix for a bug in magmom handling in Vasp2 calculator:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;magmom&#39;</span> <span class="ow">in</span> <span class="n">calc</span><span class="o">.</span><span class="n">list_float_params</span><span class="p">:</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">list_float_params</span><span class="p">[</span><span class="s1">&#39;magmom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cryst</span><span class="o">.</span><span class="n">get_initial_magnetic_moments</span><span class="p">()</span>
</pre></div>
<p>Just copy the above code to a new cell here and execute it.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Setup the calculator - single point energy calculation</span>
<span class="c1"># The details will change here from case to case</span>
<span class="c1"># We are using run-vasp from the current directory!</span>
<span class="n">calc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/calc&#39;</span><span class="p">)</span>
<span class="n">calc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s1">/run-vasp -J &quot;hecss-3C-SiC-</span><span class="si">{</span><span class="n">supercell</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
<span class="n">calc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">nsw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cryst</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You should probably check the calculator setup and the stress tensor of the supercell to make sure it is in equilibrium before running long sequence of
DFT calculations. Here is an example:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stress tensor: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">calc</span><span class="o">.</span><span class="n">get_stress</span><span class="p">()</span><span class="o">/</span><span class="n">un</span><span class="o">.</span><span class="n">GPa</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ss</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GPa&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Stress tensor: -0.000 -0.000 -0.000 0.000 0.000 0.000 GPa
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Space for results</span>
<span class="n">confs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dfsetfn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/phon/DFSET_T</span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">K&#39;</span>
<span class="n">calc_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">/calc/T</span><span class="si">{</span><span class="n">T</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">K/&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Build the sampler</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">HECSS</span><span class="p">(</span><span class="n">cryst</span><span class="p">,</span> <span class="n">calc</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">calc_dir</span><span class="p">,</span>
                <span class="c1"># sigma=3,  # Use if the energy distribution comes out too narrow</span>
                <span class="c1"># reuse_base=f&#39;{base_dir}/calc/&#39; # Use if you want to reuse the base calc</span>
               <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Iterate over samples (conf == n, i, x, f, e) collect the configurations</span>
<span class="c1"># and write displacement-force data to the dfsetfn file</span>
<span class="c1"># You can continue the iteration by manually increasing N and just</span>
<span class="c1"># re-running this loop. It will continue from the last computed sample.</span>
<span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">sampler</span><span class="p">:</span>
    <span class="c1"># Collect results</span>
    <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>    
    <span class="n">write_dfset</span><span class="p">(</span><span class="n">dfsetfn</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
    
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Check if we have enough samples</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">N</span><span class="p">:</span>
        <span class="k">break</span>
    
    <span class="c1"># Check for the manual stop file in calc_dir</span>
    <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">calc_dir</span><span class="si">}</span><span class="s1">/STOP_HECSS&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">calc_dir</span><span class="si">}</span><span class="s1">/STOP_HECSS&#39;</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sample:1622  a: 87.4%  w:1.1210  &lt;w&gt;:1.1298  alpha: 1.063e+00 </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Need more samples. Increase N and run the loop above again.</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">2000</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

